<!-- login.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ... existing head content ... -->
   <meta charset="UTF-8">
  <title>Login | Dermastreak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .btn-scale { transition: transform 0.3s ease; display: inline-block; }
    .btn-scale:hover, .btn-scale:focus { transform: scale(1.05); outline: none; }
  </style>
</head>
</head>
<body class="bg-gray-100 text-slate-900 min-h-screen flex flex-col">

<!-- ... existing header and form ... -->
   <!-- Header -->
    <header class="bg-white shadow">
      <nav
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16"
      >
        <a href="home.html" class="flex items-center space-x-3">
          <img
            src="WhatsApp Image 2025-07-15 at 14.21.54_e1b4ade7.jpg"
            class="h-12 w-12 rounded-full"
            alt="Dermastreak Logo"
          />
          <span class="font-extrabold text-slate-900 text-lg">Dermastreak</span>
        </a>
        <div class="hidden md:flex items-center space-x-4 text-sm font-normal">
          <a href="home.html" class="hover:text-green-600">Home</a>
          <a href="about.html" class="hover:text-green-600 ">About</a>
          <a href="services.html" class="hover:text-green-600">Services</a>
          <a href="blog.html" class="hover:text-green-600">Blog</a>
          <a href="contact.html" class="hover:text-green-600">Contact</a>
          <a
            href="login.html"
            class="inline-flex btn-scale items-center px-4 py-2 border border-transparent text-sm font-semibold rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >Login</a
          >
          <a
            href="registration.html"
            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-gray-50 focus:ring-2 focus:ring-offset-2 focus:ring-green-500 text-green-500"
            >Sign Up</a
          >
        </div>




</header>

<!-- Login Form -->
 <main class="max-w-md mx-auto px-6 py-16">
  <div class="bg-white p-8 rounded-xl shadow-lg space-y-6">
    <h1 class="text-3xl font-bold text-center">Login to Your Account</h1>
    <form id="loginForm" class="space-y-5">
      <input id="name" type="text" placeholder="Username" class="w-full border rounded-lg px-4 py-2">
      <input id="email" type="email" placeholder="Email" class="w-full border rounded-lg px-4 py-2">
      <input id="password" type="password" placeholder="Password" class="w-full border rounded-lg px-4 py-2">
      <select id="userType" class="w-full border rounded-lg px-4 py-2">
        <option value="">Select your role</option>
        <option value="patient">Patient</option>
        <option value="doctor">Doctor</option>
      </select>
      <div class="flex justify-between items-center text-sm">
        <label><input type="checkbox" id="rememberMe" class="mr-2"> Remember Me</label>
        <a href="#" onclick="resetPassword()" class="text-green-600 hover:underline">Forgot Password?</a>
      </div>
      <p id="loginResponse" class="text-center text-red-600 font-medium"></p>
      <button type="submit" id="loginButton" class="w-full bg-green-600 text-white font-semibold py-3 rounded-md hover:bg-green-700">Login</button>
    </form>
    <p class="text-center text-sm">Don't have an account? <a href="registration.html" class="text-green-600 hover:underline">Sign Up</a></p>
  </div>
</main>

    <!-- Footer -->
    <footer
      class="w-full bg-[#0a1e3a] text-slate-300 border-t border-gray-700 py-10"
    >
      <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-8 px-6">
        <div>
          <img
            src="WhatsApp Image 2025-07-15 at 14.21.54_e1b4ade7.jpg"
            alt="Dermastreak Logo"
            class="w-16 h-16 mb-4 rounded-full"
          />
          <p class="text-sm leading-relaxed">
            Dermastreak helps you track skin progress, get AI insights, and
            consult top dermatologists‚Äîall from your phone.
          </p>
        </div>
        <div>
          <h3 class="text-white font-bold text-lg mb-4">Quick Links</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="home.html" class="hover:underline">Home</a></li>
            <li><a href="about.html" class="hover:underline">About Us</a></li>
            <li>
              <a href="services.html" class="hover:underline">Our Services</a>
            </li>
            <li>
              <a href="blog.html" class="hover:underline">Skin Tips Blog</a>
            </li>
            <li><a href="contact.html" class="hover:underline">Contact</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-white font-bold text-lg mb-4">Contact Us</h3>
          <p class="text-sm">üìç Tamil Nadu, India</p>
          <p class="text-sm mt-2">üìû +91 98765 43210</p>
          <p class="text-sm mt-2">‚úâÔ∏è support@dermastreak.com</p>
          <p class="text-sm mt-2">Mon - Fri: 9 AM - 6 PM</p>
        </div>
        <div>
          <h3 class="text-white font-bold text-lg mb-4">Legal & Social</h3>
          <ul class="space-y-2 text-sm mb-4">
            <li>
              <a href="privacy.html" class="hover:underline">Privacy Policy</a>
            </li>
            <li>
              <a href="terms.html" class="hover:underline"
                >Terms & Conditions</a
              >
            </li>
          </ul>
          <div class="flex space-x-4">
            <a href="#" class="hover:text-white"
              ><i class="fab fa-facebook-f"></i
            ></a>
            <a href="#" class="hover:text-white"
              ><i class="fab fa-instagram"></i
            ></a>
            <a href="#" class="hover:text-white"
              ><i class="fab fa-twitter"></i
            ></a>
            <a href="#" class="hover:text-white"
              ><i class="fab fa-linkedin-in"></i
            ></a>
          </div>
        </div>
      </div>
      <div
        class="border-t border-gray-700 mt-10 pt-6 text-center text-sm text-slate-400 px-6"
      >
        ¬© 2025 Dermastreak. All rights reserved.
      </div>
    </footer>


<!-- Updated Firebase Login Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBoScNEhiFNdljF9D_BK8aBGuJiJ9XpX8o",
    authDomain: "dermastreak-2caae.firebaseapp.com",
    projectId: "dermastreak-2caae",
    storageBucket: "dermastreak-2caae.appspot.com",
    messagingSenderId: "32726012100",
    appId: "1:32726012100:web:b5a2071c3ecea58810b991"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Handle Login Submission
  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const loginBtn = document.getElementById("loginButton");
    const responseMsg = document.getElementById("loginResponse");
    responseMsg.textContent = "";
    loginBtn.disabled = true;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

    const username = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const userType = document.getElementById("userType").value;

    if (!username || !email || !password || !userType) {
      responseMsg.textContent = "Please fill in all fields.";
      loginBtn.disabled = false;
      loginBtn.innerHTML = "Login";
      return;
    }

    try {
      const userCred = await signInWithEmailAndPassword(auth, email, password);
      const user = userCred.user;

      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) throw new Error("User profile not found.");

      const userData = userDoc.data();
      
      // Case-insensitive role check
      if (userData.role.toLowerCase() !== userType.toLowerCase()) {
        throw new Error(`Please login as a ${userData.role}`);
      }

      // Store user data in session storage
      sessionStorage.setItem("username", userData.name || username);
      sessionStorage.setItem("userRole", userData.role);
      sessionStorage.setItem("userId", user.uid);
      sessionStorage.setItem("userEmail", user.email);

      // Set manual login flag for new sessions
      localStorage.setItem("manualLogin", "true");

      responseMsg.textContent = "Login successful! Redirecting...";
      responseMsg.className = "text-center text-green-600 font-medium";

      setTimeout(() => {
        const redirectUrl = userData.role.toLowerCase() === "doctor" 
          ? "doctordashboard.html" 
          : "patient.html";
        window.location.href = redirectUrl;
      }, 1000);

    } catch (error) {
      console.error("Login Error:", error.message);
      let errorMsg = "Login failed. Please try again.";
      if (error.code === "auth/user-not-found") errorMsg = "User not found.";
      else if (error.code === "auth/wrong-password") errorMsg = "Incorrect password.";
      else if (error.message) errorMsg = error.message;

      responseMsg.textContent = errorMsg;
      loginBtn.disabled = false;
      loginBtn.innerHTML = "Login";
    }
  });

  // Password Reset - unchanged
  window.resetPassword = async function() {
    const email = prompt("Enter your email to reset password:");
    if (email) {
      try {
        await sendPasswordResetEmail(auth, email);
        alert("Password reset email sent. Check your inbox.");
      } catch (error) {
        alert("Error: " + error.message);
      }
    }
  }

  // Modified Auto-Redirect Logic
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          
          // Use sessionStorage if available, otherwise use localStorage as fallback
          const userRole = sessionStorage.getItem("userRole") || userData.role;
          
          // Set session storage if not already set
          if (!sessionStorage.getItem("userId")) {
            sessionStorage.setItem("username", userData.name || user.displayName || "");
            sessionStorage.setItem("userRole", userRole);
            sessionStorage.setItem("userId", user.uid);
            sessionStorage.setItem("userEmail", user.email);
          }

          const redirectUrl = userRole.toLowerCase() === "doctor" 
            ? "doctordashboard.html" 
            : "patient.html";
            
          window.location.href = redirectUrl;
        }
      } catch (error) {
        console.error("Auto-redirect error:", error);
      }
    }
  });

  // Logout function - unchanged
  window.logout = async function() {
    await signOut(auth);
    localStorage.removeItem("manualLogin");
    sessionStorage.clear();
    window.location.href = "login.html";
  }
</script>

</body>
</html>